<style>
    :root {
        --gold: #d6a45a;
        --gold-soft: #e3b873;
        --text: #f5f2ee;
        --muted: rgba(245, 242, 238, 0.7);
        --dark: #0a0a0a;
        --darker: #000;
        --primary: #f5f2ee;
        --secondary: #0a0a0a;
    }
    .menu-section {
        padding: 2rem 0;
        position: relative;
        overflow: hidden;
    }
    .menu-section:before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 1px;
        background: linear-gradient(90deg, transparent, rgba(214, 164, 90, 0.3), transparent);
    }
    .menu-item {
        background: rgba(20, 20, 20, 0.8);
        border: 1px solid rgba(214, 164, 90, 0.2);
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    .menu-item:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        border-color: rgba(214, 164, 90, 0.4);
    }
    .menu-item h5 {
        color: var(--gold);
        font-weight: 600;
        margin-bottom: 0.5rem;
    }
    .price-tag {
        background: var(--gold);
        color: #000;
        padding: 0.25rem 1rem;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.9rem;
        display: inline-block;
        margin-top: 0.5rem;
    }
    .filter-btn {
        background: transparent;
        border: 1px solid var(--gold);
        color: var(--gold);
        padding: 0.5rem 1.5rem;
        margin: 0.25rem;
        border-radius: 30px;
        transition: all 0.3s ease;
        font-weight: 500;
        text-transform: uppercase;
        font-size: 0.8rem;
    }
    .filter-btn:hover, .filter-btn.active {
        background: var(--gold);
        color: #000;
        border-color: var(--gold);
    }
    .hero-section {
        position: relative;
        padding: 8rem 0 4rem;
    }
    .hero-section h1 {
        font-family: 'Playfair Display', serif;
        font-size: 3.5rem;
        font-weight: 700;
        color: var(--gold);
    }
    .menu-hover-img {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: 8px;
        margin-left: 1rem;
    }
    .reviews-btn {
        background-color: var(--gold);
        color: var(--dark);
        border: none;
        border-radius: 20px;
        padding: 0.3rem 0.8rem;
        font-size: 0.8rem;
        transition: all 0.3s ease;
        cursor: pointer;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    .reviews-btn:hover {
        background-color: var(--gold-soft);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(214, 164, 90, 0.4);
    }

    .reviews-btn:active {
        transform: translateY(0);
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    /* Swiggy-style Menu Cards */
    .menu-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1.5rem;
        margin-bottom: 3rem;
    }

    .menu-card {
        background: var(--secondary);
        border-radius: 16px;
        overflow: hidden;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        cursor: pointer;
        position: relative;
        height: 420px;
        display: flex;
        flex-direction: column;
    }

    .menu-card:hover {
        transform: translateY(-6px);
        box-shadow: 0 12px 24px rgba(214, 164, 90, 0.25);
    }

    .menu-card-image {
        width: 100%;
        height: 180px;
        object-fit: contain;
        object-position: center;
        border-radius: 16px 16px 0 0;
        transition: transform 0.3s ease;
        flex-shrink: 0;
        background: var(--dark);
    }

    .menu-card:hover .menu-card-image {
        transform: scale(1.08);
    }

    .menu-card-content {
        padding: 1.2rem;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
    }

    .menu-card-title {
        font-family: 'Playfair Display', serif;
        font-size: 1.2rem;
        font-weight: 700;
        color: var(--primary);
        margin-bottom: 0.6rem;
        line-height: 1.2;
        flex-shrink: 0;
    }

    .menu-card-description {
        color: var(--gold-soft);
        font-size: 0.85rem;
        line-height: 1.4;
        margin-bottom: 0.8rem;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
        flex-grow: 1;
        min-height: 2.4rem;
        max-height: 2.4rem;
    }

    .menu-card-footer {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        padding-top: 0.8rem;
        border-top: 1px solid rgba(214, 164, 90, 0.2);
        margin-top: auto;
        flex-shrink: 0;
        min-height: 70px;
    }

    .menu-card-price {
        font-size: 1.3rem;
        font-weight: 700;
        color: var(--gold);
        flex-shrink: 0;
    }

    .menu-card-actions {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        flex-shrink: 0;
        align-items: flex-end;
        min-width: 120px;
    }

    .menu-card-buttons {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        width: 100%;
        justify-content: flex-end;
    }

    .menu-card-add {
        background: var(--gold);
        color: var(--dark);
        border: none;
        border-radius: 8px;
        padding: 0.5rem 1rem;
        font-size: 0.85rem;
        font-weight: 600;
        transition: all 0.3s ease;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        flex-shrink: 0;
        white-space: nowrap;
    }

    .menu-card-wishlist {
        background: transparent;
        color: var(--gold);
        border: 1px solid var(--gold);
        border-radius: 8px;
        padding: 0.4rem 0.8rem;
        font-size: 0.8rem;
        font-weight: 500;
        transition: all 0.3s ease;
        cursor: pointer;
        flex-shrink: 0;
        white-space: nowrap;
        position: relative;
    }

    .menu-card-wishlist:hover {
        background: var(--gold);
        color: var(--dark);
        transform: translateY(-1px);
    }

    .menu-card-wishlist:hover::after {
        content: 'Add to Wishlist';
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 0.3rem 0.6rem;
        border-radius: 4px;
        font-size: 0.7rem;
        white-space: nowrap;
        z-index: 1000;
        margin-bottom: 5px;
    }

    /* Quantity Controls */
    .quantity-controls {
        display: flex;
        align-items: center;
        background: var(--gold);
        border-radius: 8px;
        padding: 0.2rem;
        gap: 0.5rem;
        min-width: 100px;
        justify-content: space-between;
    }

    .quantity-btn {
        background: transparent;
        border: none;
        color: var(--dark);
        font-size: 1rem;
        font-weight: bold;
        cursor: pointer;
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
        transition: all 0.2s ease;
        min-width: 25px;
        height: 25px;
        display: flex;
        align-items: center;
        justify-content: center;
        user-select: none;
    }

    .quantity-btn:hover {
        background: rgba(0, 0, 0, 0.1);
    }

    .quantity-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .quantity-display {
        color: var(--dark);
        font-weight: bold;
        font-size: 0.9rem;
        min-width: 20px;
        text-align: center;
    }

    /* Wishlist States */
    .menu-card-wishlist.in-wishlist {
        background: var(--gold) !important;
        color: var(--dark) !important;
        border-color: var(--gold) !important;
    }

    .menu-card-wishlist.in-wishlist:hover {
        background: var(--gold-soft) !important;
        color: var(--dark) !important;
    }

    .menu-card-wishlist.in-wishlist:hover::after {
        content: 'Remove from Wishlist';
    }

    .menu-card-wishlist.in-wishlist i {
        color: #dc3545 !important;
    }

    /* Responsive adjustments */
    @media (max-width: 1200px) {
        .menu-grid {
            grid-template-columns: repeat(3, 1fr);
        }
    }

    @media (max-width: 900px) {
        .menu-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 600px) {
        .menu-grid {
            grid-template-columns: 1fr;
        }
        
        .menu-card {
            height: 380px;
        }
        
        .menu-card-image {
            height: 160px;
        }

        .menu-card-actions {
            min-width: 100px;
        }

        .menu-card-buttons {
            flex-direction: column;
            gap: 0.3rem;
        }

        .menu-card-add, .menu-card-wishlist {
            font-size: 0.8rem;
            padding: 0.4rem 0.8rem;
        }
    }
</style>

<section class="hero-section text-center">
    <div class="hero-content">
        <img src="/assets/logo-icon.png" alt="Rabuste Coffee Logo" class="hero-logo" style="display:block; margin:0 auto 20px auto; width:120px;">
        <h1 class="font-playfair display-1 fw-bold mb-4 text-white hero-title" style="background: linear-gradient(45deg, var(--gold), var(--gold-soft)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">Our Menu</h1>
        <p class="lead mb-5 fs-4 text-white hero-subtitle">Discover our carefully crafted selection of premium coffee and delicious treats</p>
    </div>
    <div class="particles"></div>
</section>

<section class="py-5" style="background: var(--secondary);" id="menu-wrapper">
    <div class="container mt-5">
        <div class="text-center">
            <div class="btn-group flex-wrap menu-filters" role="group" id="menu-filters">
                <a href="#all" class="filter-btn active" data-filter="all">All Items</a>
                <a href="#cold" class="filter-btn" data-filter="cold">Cold</a>
                <a href="#hot" class="filter-btn" data-filter="hot">Hot</a>
                <a href="#manual-brew" class="filter-btn" data-filter="manual-brew">Manual Brew</a>
                <a href="#shakes-tea" class="filter-btn" data-filter="shakes-tea">Shakes & Tea</a>
                <a href="#food" class="filter-btn" data-filter="food">Food</a>
            </div>
        </div>
    </div>
</section>

<main class="container py-5" id="menu-content">
    <% 
    const categoryNames = {
        'cold': 'Cold Coffee',
        'hot': 'Hot Coffee',
        'manual-brew': 'Manual Brew',
        'shakes-tea': 'Shakes & Tea',
        'food': 'Food Menu'
    };
    const subCategoryNames = {
        'robusta-cold-non-milk': 'Non-Milk Based',
        'robusta-cold-milk': 'Milk Based',
        'robusta-hot-non-milk': 'Non-Milk Based',
        'robusta-hot-milk': 'Milk Based',
        'blend-cold-non-milk': 'Non-Milk Based',
        'blend-cold-milk': 'Milk Based',
        'blend-hot-non-milk': 'Non-Milk Based',
        'blend-hot-milk': 'Milk Based',
        'cold-brew': 'Cold Brew',
        'pour-over': 'Pour Over',
        'shakes': 'Shakes',
        'cold-tea': 'Cold Tea',
        'snacks-sides': 'Snacks & Sides',
        'bagels-croissants': 'Bagels & Croissants'
    };
    %>
    
    <!-- Recommended Items Section -->
    <% if (typeof recommendedItems !== 'undefined' && recommendedItems && recommendedItems.length > 0) { %>
        <section class="py-5 menu-section" style="background: var(--secondary);" data-category="recommended">
            <div class="container py-5">
                <h2 class="font-playfair fs-2 fw-bold mb-3 text-center" style="color: var(--primary);">
                    ‚òÖ Recommended for You
                </h2>
                <p class="text-center mb-5" style="color: var(--gold-soft); font-size: 1.1rem;">
                    Our AI-powered picks just for you
                </p>
                <div class="menu-grid">
                    <% recommendedItems.forEach(item => { %>
                        <div class="menu-card" style="border: 2px solid var(--gold); box-shadow: 0 0 20px rgba(214, 164, 90, 0.3);">
                            <% if (item.image) { %>
                                <img src="<%= item.image.startsWith('/') ? item.image : '/assets/menu_images/' + item.image %>" 
                                     class="menu-card-image" 
                                     alt="<%= item.name %>"
                                     onerror="this.src='/assets/placeholder.jpg'; console.log('Image failed to load:', this.src);"
                                     onerror="this.src='/assets/placeholder-food.jpg'">
                            <% } %>
                            <div class="menu-card-content">
                                <div style="position: absolute; top: 10px; right: 10px; background: var(--gold); color: #000; padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600;">
                                    ‚≠ê Recommended
                                </div>
                                <h5 class="menu-card-title"><%= item.name %></h5>
                                <% if (item.description) { %>
                                    <p class="menu-card-description"><%= item.description %></p>
                                <% } %>
                                <div class="menu-card-footer">
                                    <span class="menu-card-price">‚Çπ<%= item.price %></span>
                                    <% 
const itemImage = item.image ? (item.image.startsWith('/') ? item.image : '/assets/menu_images/' + item.image) : '';
%>
                                    <div class="menu-card-actions">
                                        <% if (typeof isLoggedIn !== 'undefined' && isLoggedIn && currentUser) { %>
                                            <div class="menu-card-buttons">
                                                <button class="menu-card-wishlist" 
                                                        data-item-id="<%= item._id %>"
                                                        onclick="toggleWishlistItem('<%= item._id %>', '<%= item.name.replace(/'/g, "\\'") %>', <%= item.price %>, '<%= itemImage %>', this)">
                                                    <span style="color: #dc3545;">‚ô•</span>
                                                </button>
                                                <button class="menu-card-add" 
                                                        data-item-id="<%= item._id %>"
                                                        data-item-name="<%= item.name.replace(/'/g, "\\'") %>"
                                                        data-item-price="<%= item.price %>"
                                                        data-item-image="<%= itemImage %>"
                                                        onclick="addToCartItem('<%= item._id %>', '<%= item.name.replace(/'/g, "\\'") %>', <%= item.price %>, '<%= itemImage %>', this)">
                                                    Add +
                                                </button>
                                            </div>
                                        <% } else { %>
                                            <a href="/signup" class="menu-card-add" style="text-decoration: none; display: inline-block; text-align: center;">
                                                Sign Up
                                            </a>
                                        <% } %>
                                    </div>
                                </div>
                            </div>
                        </div>
                    <% }); %>
                </div>
            </div>
        </section>
    <% } %>
    
    <!-- DEBUG: Menu Items Check -->
    <div style="display: none;">
        Debug: typeof menuItems = <%= typeof menuItems %>
        Debug: menuItems exists = <%= typeof menuItems !== 'undefined' %>
        Debug: Object.keys length = <%= typeof menuItems !== 'undefined' ? Object.keys(menuItems).length : 'N/A' %>
    </div>
    
    <% if (typeof menuItems !== 'undefined' && Object.keys(menuItems).length > 0) { %>
        <% Object.keys(menuItems).forEach(category => { %>
            <section class="py-5 menu-section" style="background: var(--secondary);" data-category="<%= category %>">
                <div class="container py-5">
                    <h2 class="font-playfair fs-2 fw-bold mb-5 text-center" style="color: var(--primary);">
                        <i class="fas fa-<%= category === 'cold' ? '‚ùÑÔ∏è' : category === 'hot' ? 'üî•' : category === 'manual-brew' ? '‚òï' : category === 'shakes-tea' ? 'ü•§' : 'üçΩÔ∏è' %> me-3"></i>
                        <%= categoryNames[category] || category %>
                    </h2>
                    <% Object.keys(menuItems[category]).forEach(subCategory => { %>
                        <h4 class="font-playfair fw-bold mb-4" style="color: var(--primary);">
                            <%= subCategoryNames[subCategory] || subCategory %>
                        </h4>
                        <div class="menu-grid">
                            <% menuItems[category][subCategory].forEach(item => { %>
                                <div class="menu-card">
                                    <% if (item.image) { %>
                                        <img src="<%= item.image.startsWith('/') ? item.image : '/assets/menu_images/' + item.image %>" 
                                             class="menu-card-image" 
                                             alt="<%= item.name %>"
                                             onerror="this.src='/assets/placeholder.jpg'; console.log('Image failed to load:', this.src);"
                                             onerror="this.src='/assets/placeholder-food.jpg'">
                                    <% } %>
                                    <div class="menu-card-content">
                                        <h5 class="menu-card-title"><%= item.name %></h5>
                                        <% if (item.description) { %>
                                            <p class="menu-card-description"><%= item.description %></p>
                                        <% } %>
                                        <div class="menu-card-footer">
                                            <span class="menu-card-price">‚Çπ<%= item.price %></span>
                                            <% 
const itemImage = item.image ? (item.image.startsWith('/') ? item.image : '/assets/menu_images/' + item.image) : '';
%>
                                            <div class="menu-card-actions">
                                                <% if (typeof isLoggedIn !== 'undefined' && isLoggedIn && currentUser) { %>
                                                    <!-- User is logged in - show both buttons -->
                                                    <div class="menu-card-buttons">
                                                        <button class="menu-card-wishlist" 
                                                                data-item-id="<%= item._id %>"
                                                                onclick="toggleWishlistItem('<%= item._id %>', '<%= item.name.replace(/'/g, "\\'") %>', <%= item.price %>, '<%= itemImage %>', this)">
                                                            <span style="color: #dc3545;">‚ô•</span>
                                                        </button>
                                                        <button class="menu-card-add" 
                                                                data-item-id="<%= item._id %>"
                                                                data-item-name="<%= item.name.replace(/'/g, "\\'") %>"
                                                                data-item-price="<%= item.price %>"
                                                                data-item-image="<%= itemImage %>"
                                                                onclick="addToCartItem('<%= item._id %>', '<%= item.name.replace(/'/g, "\\'") %>', <%= item.price %>, '<%= itemImage %>', this)">
                                                            Add +
                                                        </button>
                                                    </div>
                                                <% } else { %>
                                                    <!-- User not logged in - show Sign Up button -->
                                                    <a href="/signup" class="menu-card-add" style="text-decoration: none; display: inline-block; text-align: center;">
                                                        Sign Up
                                                    </a>
                                                <% } %>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            <% }); %>
                        </div>
                    <% }); %>
                </div>
            </section>
        <% }); %>
    <% } else { %>
        <div class="text-center py-5">
            <p class="text-muted">No menu items available at the moment.</p>
        </div>
    <% } %>
</main>

<script>
    // Toggle reviews visibility
    function toggleReviews(button) {
        const itemId = button.getAttribute('data-item-id');
        const reviewsDiv = document.getElementById('reviews-' + itemId);
        
        if (reviewsDiv.style.display === 'none') {
            reviewsDiv.style.display = 'block';
            button.style.backgroundColor = 'var(--gold-soft)';
        } else {
            reviewsDiv.style.display = 'none';
            button.style.backgroundColor = 'var(--gold)';
        }
    }

    // Global state management
    let cartItems = new Map(); // itemId -> quantity
    let wishlistItems = new Set(); // itemId set
    let pendingOperations = new Set(); // Track pending operations to prevent duplicates

    // Debounce function to prevent rapid clicks
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // Cart and Wishlist functions - Define immediately for onclick handlers
    window.addToCartItem = function(itemId, itemName, price, image, buttonElement) {
        console.log('üõí Adding to cart:', { itemId, itemName, price, image });
        
        // Prevent multiple simultaneous calls
        if (buttonElement && buttonElement.disabled) return;
        if (buttonElement) buttonElement.disabled = true;
        
        // Optimistically update UI
        const currentQuantity = cartItems.get(itemId) || 0;
        const newQuantity = currentQuantity + 1;
        cartItems.set(itemId, newQuantity);
        if (buttonElement) updateCartButtonState(buttonElement, newQuantity, itemId, itemName, price, image);
        
        fetch('/api/cart/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'include',
            body: JSON.stringify({
                itemId: itemId,
                name: itemName,
                price: price,
                image: image,
                quantity: 1
            })
        })
        .then(response => {
            console.log('üì° Cart API response status:', response.status);
            if (response.status === 401) {
                console.log('üîí User not authenticated, redirecting to signin');
                window.location.href = '/signin';
                return;
            }
            return response.json();
        })
        .then(data => {
            console.log('üì¶ Cart API response data:', data);
            if (data && data.success) {
                showNotification('Item added to cart!', 'success');
                updateCartCount();
                
                // Show recommendations if available
                console.log('üîç Checking recommendations:', data.recommendations);
                if (data.recommendations && Array.isArray(data.recommendations) && data.recommendations.length > 0) {
                    console.log('‚úÖ Showing', data.recommendations.length, 'recommendations');
                    showRecommendations(data.recommendations, itemName);
                } else {
                    console.log('‚ö†Ô∏è No recommendations received from server');
                }
            } else if (data) {
                // Revert optimistic update on failure
                const revertQuantity = Math.max(0, newQuantity - 1);
                cartItems.set(itemId, revertQuantity);
                if (buttonElement) updateCartButtonState(buttonElement, revertQuantity);
                showNotification(data.message || 'Failed to add item to cart', 'error');
            }
        })
        .catch(error => {
            console.error('‚ùå Error adding to cart:', error);
            // Revert optimistic update on error
            const revertQuantity = Math.max(0, newQuantity - 1);
            cartItems.set(itemId, revertQuantity);
            if (buttonElement) updateCartButtonState(buttonElement, revertQuantity, itemId, itemName, price, image);
            showNotification('Failed to add item to cart', 'error');
        })
        .finally(() => {
            if (buttonElement) buttonElement.disabled = false;
        });
    };

    window.toggleWishlistItem = function(itemId, itemName, price, image, buttonElement) {
        const inWishlist = wishlistItems.has(String(itemId));
        
        if (inWishlist) {
            // Remove from wishlist
            removeFromWishlist(String(itemId), buttonElement);
        } else {
            // Add to wishlist
            addToWishlistItem(String(itemId), itemName, price, image, buttonElement);
        }
    };

    console.log('‚úÖ Global functions defined');

    // Filter functionality
    document.addEventListener('DOMContentLoaded', async function() {
        const filterButtons = document.querySelectorAll('.filter-btn');
        const menuSections = document.querySelectorAll('.menu-section');
        
        // Load initial cart and wishlist state
        await loadInitialState();
        
        filterButtons.forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                const filter = this.getAttribute('data-filter');
                
                filterButtons.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                
                menuSections.forEach(section => {
                    const sectionCategory = section.getAttribute('data-category');
                    if (filter === 'all' || sectionCategory === filter) {
                        section.style.display = 'block';
                    } else {
                        section.style.display = 'none';
                    }
                });
            });
        });
        
        console.log('‚úÖ Menu page loaded successfully');
    });

    // Load initial cart and wishlist state
    async function loadInitialState() {
        try {
            console.log('üîÑ Loading initial cart and wishlist state...');
            
            // Load cart items
            const cartResponse = await fetch('/api/cart');
            if (cartResponse.ok) {
                const cart = await cartResponse.json();
                console.log('üì¶ Loaded cart:', cart);
                cart.forEach(item => {
                    cartItems.set(String(item.itemId), item.quantity);
                });
                console.log('‚úÖ Cart items loaded:', cartItems.size);
            }

            // Load wishlist items
            const wishlistResponse = await fetch('/api/wishlist');
            if (wishlistResponse.ok) {
                const wishlist = await wishlistResponse.json();
                console.log('‚ù§Ô∏è Loaded wishlist:', wishlist);
                wishlist.forEach(item => {
                    wishlistItems.add(String(item.itemId));
                });
                console.log('‚úÖ Wishlist items loaded:', wishlistItems.size);
            }

            // Update UI based on loaded state
            updateAllButtonStates();
        } catch (error) {
            console.log('‚ö†Ô∏è Could not load initial state:', error.message);
        }
    }

    // Update all button states based on current cart and wishlist
    function updateAllButtonStates() {
        console.log('üîÑ Updating all button states...');
        
        // Find all cart buttons (using class menu-card-add)
        const cartButtons = document.querySelectorAll('.menu-card-add');
        console.log('Found', cartButtons.length, 'cart buttons');
        
        cartButtons.forEach(button => {
            const itemId = button.getAttribute('data-item-id');
            if (itemId) {
                const quantity = cartItems.get(String(itemId)) || 0;
                if (quantity > 0) {
                    console.log('Setting quantity', quantity, 'for item', itemId);
                    const itemName = button.getAttribute('data-item-name');
                    const itemPrice = button.getAttribute('data-item-price');
                    const itemImage = button.getAttribute('data-item-image');
                    updateCartButtonState(button, quantity, itemId, itemName, itemPrice, itemImage);
                }
            }
        });

        // Find all wishlist buttons
        const wishlistButtons = document.querySelectorAll('.menu-card-wishlist');
        console.log('Found', wishlistButtons.length, 'wishlist buttons');
        
        wishlistButtons.forEach(button => {
            const itemId = button.getAttribute('data-item-id');
            if (itemId) {
                const inWishlist = wishlistItems.has(String(itemId));
                if (inWishlist) {
                    updateWishlistButtonState(button, true);
                }
            }
        });
        
        console.log('‚úÖ All button states updated');
    }

    // Update cart button state (Add+ vs quantity controls)
    function updateCartButtonState(button, quantity) {
        if (!button) {
            console.warn('updateCartButtonState called with null button');
            return;
        }
        
        const itemId = button.getAttribute('data-item-id') || button.dataset?.itemId;
        const itemName = button.getAttribute('data-item-name') || button.dataset?.itemName;
        const itemPrice = button.getAttribute('data-item-price') || button.dataset?.itemPrice;
        const itemImage = button.getAttribute('data-item-image') || button.dataset?.itemImage;
        
        if (quantity > 0) {
            // Show quantity controls
            button.innerHTML = `
                <div class="quantity-controls">
                    <button class="quantity-btn" onclick="event.stopPropagation(); window.changeQuantity('${itemId}', -1)">‚àí</button>
                    <span class="quantity-display">${quantity}</span>
                    <button class="quantity-btn" onclick="event.stopPropagation(); window.changeQuantity('${itemId}', 1)">+</button>
                </div>
            `;
            button.style.padding = '0.2rem';
            button.style.pointerEvents = 'auto';
        } else {
            // Show Add+ button with onclick
            button.innerHTML = 'Add +';
            button.style.padding = '0.5rem 1rem';
            button.style.pointerEvents = 'auto';
            // Re-attach onclick handler
            button.onclick = function() {
                window.addToCartItem(itemId, itemName, itemPrice, itemImage, this);
            };
        }
    }

    // Update wishlist button state (visual feedback)
    function updateWishlistButtonState(button, inWishlist) {
        if (!button) {
            console.warn('updateWishlistButtonState called with null button');
            return;
        }
        
        if (inWishlist) {
            button.classList.add('in-wishlist');
            button.innerHTML = '<i class="fas fa-heart"></i>';
        } else {
            button.classList.remove('in-wishlist');
            button.innerHTML = '<span style="color: #dc3545;">‚ô•</span>';
        }
    }

    // Show AI recommendations modal (custom implementation without Bootstrap dependency)
    function showRecommendations(recommendations, addedItemName) {
        if (!recommendations || recommendations.length === 0) {
            console.log('No recommendations to show');
            return;
        }
        
        console.log('‚ú® Showing recommendations modal with', recommendations.length, 'items');
        
        // Remove existing modal if any
        const existingModal = document.getElementById('recommendationsModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        const modalHtml = `
            <div id="recommendationsModal" onclick="if(event.target.id === 'recommendationsModal') closeRecommendationsModal()" style="
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                z-index: 999999;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
                animation: fadeIn 0.3s ease;
            ">
                <div style="
                    background: #0a0a0a;
                    border: 2px solid #d6a45a;
                    border-radius: 12px;
                    max-width: 1200px;
                    width: 100%;
                    max-height: 90vh;
                    overflow-y: auto;
                    position: relative;
                ">
                    <div style="
                        padding: 20px;
                        border-bottom: 1px solid #d6a45a;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        position: sticky;
                        top: 0;
                        background: #0a0a0a;
                        z-index: 1;
                    ">
                        <h5 style="color: #d6a45a; margin: 0; font-size: 1.5rem;">
                            <i class="bi bi-stars"></i> Recommended for you with ${addedItemName}
                        </h5>
                        <button onclick="closeRecommendationsModal()" style="
                            background: transparent;
                            border: none;
                            color: #d6a45a;
                            font-size: 2rem;
                            cursor: pointer;
                            padding: 0;
                            width: 40px;
                            height: 40px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                        ">&times;</button>
                    </div>
                    <div style="padding: 20px;">
                        <div style="
                            display: grid;
                            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                            gap: 20px;
                        ">
                            ${recommendations.map(item => `
                                <div style="
                                    background: rgba(20, 20, 20, 0.9);
                                    border: 1px solid rgba(214, 164, 90, 0.3);
                                    border-radius: 12px;
                                    overflow: hidden;
                                    transition: transform 0.3s ease;
                                " onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                                    ${item.image ? `<img src="${item.image}" alt="${item.name}" style="width: 100%; height: 180px; object-fit: cover;">` : 
                                    `<div style="width: 100%; height: 180px; background: linear-gradient(135deg, #d6a45a 0%, #b8884a 100%); display: flex; align-items: center; justify-content: center;">
                                        <i class="bi bi-cup-hot" style="font-size: 3rem; color: #000;">‚òï</i>
                                    </div>`}
                                    <div style="padding: 15px;">
                                        <h6 style="color: #d6a45a; font-weight: 600; margin-bottom: 8px;">${item.name}</h6>
                                        <p style="color: #ccc; font-size: 0.85rem; margin-bottom: 12px; min-height: 40px;">${item.description || item.category || ''}</p>
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <span style="color: #d6a45a; font-weight: bold; font-size: 1.2rem;">‚Çπ${item.price}</span>
                                            <button onclick="addRecommendedItem('${item._id}', '${item.name.replace(/'/g, "\\'")}', ${item.price}, '${item.image || ''}')" style="
                                                background: #d6a45a;
                                                color: #000;
                                                border: none;
                                                padding: 8px 16px;
                                                border-radius: 8px;
                                                font-weight: 600;
                                                cursor: pointer;
                                                transition: all 0.3s ease;
                                            " onmouseover="this.style.background='#e3b873'" onmouseout="this.style.background='#d6a45a'">
                                                <span>üõí</span> Add
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div style="
                        padding: 20px;
                        border-top: 1px solid #d6a45a;
                        text-align: center;
                        position: sticky;
                        bottom: 0;
                        background: #0a0a0a;
                    ">
                        <button onclick="closeRecommendationsModal()" style="
                            background: #d6a45a;
                            color: #000;
                            border: none;
                            padding: 12px 32px;
                            border-radius: 8px;
                            font-weight: 600;
                            cursor: pointer;
                            font-size: 1rem;
                        ">Continue Shopping</button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        document.body.style.overflow = 'hidden';
        
        console.log('‚úÖ Modal displayed successfully');
    }
    
    // Close recommendations modal
    function closeRecommendationsModal() {
        const modal = document.getElementById('recommendationsModal');
        if (modal) {
            modal.style.animation = 'fadeOut 0.3s ease';
            setTimeout(() => {
                modal.remove();
                document.body.style.overflow = '';
            }, 300);
        }
    }
    
    // Add recommended item to cart
    function addRecommendedItem(itemId, itemName, price, image) {
        // Close the recommendations modal first
        closeRecommendationsModal();
        
        fetch('/api/cart/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'include',
            body: JSON.stringify({
                itemId: itemId,
                name: itemName,
                price: price,
                image: image,
                quantity: 1
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data && data.success) {
                showNotification(`${itemName} added to cart!`, 'success');
                updateCartCount();
                
                // Update cart items map
                const currentQuantity = cartItems.get(itemId) || 0;
                cartItems.set(itemId, currentQuantity + 1);
            } else {
                showNotification(data.message || 'Failed to add item', 'error');
            }
        })
        .catch(error => {
            console.error('Error adding recommended item:', error);
            showNotification('Failed to add item to cart', 'error');
        });
    }

    // Change quantity function (for + and - buttons) - with debounce
    const changeQuantity = debounce(function(itemId, change) {
        const operationKey = `${itemId}_${change}`;
        
        // Prevent duplicate operations
        if (pendingOperations.has(operationKey)) {
            console.log('Operation already pending, skipping:', operationKey);
            return;
        }
        
        pendingOperations.add(operationKey);
        
        const currentQuantity = cartItems.get(String(itemId)) || 0;
        const newQuantity = Math.max(0, currentQuantity + change);
        
        console.log(`Changing quantity for ${itemId}: ${currentQuantity} -> ${newQuantity}`);
        
        if (newQuantity <= 0) {
            // Remove item from cart
            removeFromCart(String(itemId)).finally(() => {
                pendingOperations.delete(operationKey);
            });
        } else {
            // Update quantity
            updateCartQuantity(String(itemId), newQuantity).finally(() => {
                pendingOperations.delete(operationKey);
            });
        }
    }, 300); // 300ms debounce

    // Update cart quantity
    function updateCartQuantity(itemId, newQuantity) {
        // Find the button by data-item-id attribute (using menu-card-add class)
        const button = document.querySelector(`.menu-card-add[data-item-id="${itemId}"]`);
        if (button && button.disabled) return Promise.resolve();
        
        if (button) button.disabled = true;
        
        return fetch(`/api/cart/${itemId}`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ quantity: newQuantity })
        })
        .then(response => response.json())
        .then(data => {
            if (data && data.success) {
                // Update local state
                cartItems.set(String(itemId), newQuantity);
                
                // Update button state
                if (button) {
                    const itemName = button.getAttribute('data-item-name');
                    const itemPrice = button.getAttribute('data-item-price');
                    const itemImage = button.getAttribute('data-item-image');
                    updateCartButtonState(button, newQuantity, itemId, itemName, itemPrice, itemImage);
                }
                
                updateCartCount();
            } else {
                showNotification('Failed to update quantity', 'error');
                // Revert local state on failure
                const revertButton = document.querySelector(`.menu-card-add[data-item-id="${itemId}"]`);
                if (revertButton) {
                    const revertQuantity = cartItems.get(itemId) || 0;
                    const itemName = revertButton.getAttribute('data-item-name');
                    const itemPrice = revertButton.getAttribute('data-item-price');
                    const itemImage = revertButton.getAttribute('data-item-image');
                    updateCartButtonState(revertButton, revertQuantity, itemId, itemName, itemPrice, itemImage);
                }
            }
        })
        .catch(error => {
            console.error('Error updating quantity:', error);
            showNotification('Failed to update quantity', 'error');
            // Revert local state on error
            const revertButton = document.querySelector(`.menu-card-add[data-item-id="${itemId}"]`);
            if (revertButton) {
                const revertQuantity = cartItems.get(itemId) || 0;
                const itemName = revertButton.getAttribute('data-item-name');
                const itemPrice = revertButton.getAttribute('data-item-price');
                const itemImage = revertButton.getAttribute('data-item-image');
                updateCartButtonState(revertButton, revertQuantity, itemId, itemName, itemPrice, itemImage);
            }
        })
        .finally(() => {
            if (button) button.disabled = false;
        });
    }

    // Remove from cart
    function removeFromCart(itemId) {
        return fetch(`/api/cart/${itemId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data && data.success) {
                // Update local state
                cartItems.delete(String(itemId));
                
                // Update button state
                const button = document.querySelector(`.menu-card-add[data-item-id="${itemId}"]`);
                if (button) {
                    const itemName = button.getAttribute('data-item-name');
                    const itemPrice = button.getAttribute('data-item-price');
                    const itemImage = button.getAttribute('data-item-image');
                    updateCartButtonState(button, 0, itemId, itemName, itemPrice, itemImage);
                }
                
                updateCartCount();
                showNotification('Item removed from cart', 'success');
            } else {
                showNotification('Failed to remove item', 'error');
            }
        })
        .catch(error => {
            console.error('Error removing from cart:', error);
            showNotification('Failed to remove item', 'error');
        });
    }


    function addToWishlistItem(itemId, itemName, price, image, buttonElement) {
        console.log('Adding to wishlist:', { itemId, itemName, price, image });
        
        fetch('/api/wishlist/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'include',
            body: JSON.stringify({
                itemId: itemId,
                name: itemName,
                price: price,
                image: image
            })
        })
        .then(response => {
            if (response.status === 401) {
                // Not authenticated, redirect to signin
                window.location.href = '/signin';
                return;
            }
            return response.json();
        })
        .then(data => {
            if (data && data.success) {
                // Update local state
                wishlistItems.add(String(itemId));
                
                // Update button state
                updateWishlistButtonState(buttonElement, true);
                
                showNotification('Item added to wishlist!', 'success');
                updateWishlistCount();
            } else if (data) {
                showNotification(data.message || 'Failed to add item to wishlist', 'error');
            }
        })
        .catch(error => {
            console.error('Error adding to wishlist:', error);
            showNotification('Failed to add item to wishlist', 'error');
        });
    }

    function removeFromWishlist(itemId, buttonElement) {
        fetch(`/api/wishlist/${itemId}`, {
            method: 'DELETE',
            credentials: 'include'
        })
        .then(response => response.json())
        .then(data => {
            if (data && data.success) {
                // Update local state
                wishlistItems.delete(String(itemId));
                
                // Update button state
                updateWishlistButtonState(buttonElement, false);
                
                showNotification('Item removed from wishlist', 'success');
                updateWishlistCount();
            } else {
                showNotification('Failed to remove from wishlist', 'error');
            }
        })
        .catch(error => {
            console.error('Error removing from wishlist:', error);
            showNotification('Failed to remove from wishlist', 'error');
        });
    }

    // Notification system
    function showNotification(message, type) {
        console.log('Showing notification:', message, type);
        
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} position-fixed`;
        notification.style.cssText = `
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 300px;
            animation: slideInRight 0.3s ease;
        `;
        notification.innerHTML = `
            <span class="${type === 'success' ? '‚úì' : '‚ö†Ô∏è'}"></span>
            ${message}
        `;
        
        document.body.appendChild(notification);
        
        // Auto remove after 3 seconds
        setTimeout(() => {
            notification.style.animation = 'slideOutRight 0.3s ease';
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }, 3000);
    }

    // Update cart count in navbar if element exists
    function updateCartCount() {
        fetch('/api/cart/count')
        .then(response => response.json())
        .then(data => {
            const cartCount = document.querySelector('.cart-count');
            if (cartCount) {
                cartCount.textContent = data.count || 0;
            }
        })
        .catch(error => console.error('Error updating cart count:', error));
    }

    function updateWishlistCount() {
        fetch('/api/wishlist/count')
        .then(response => response.json())
        .then(data => {
            const wishlistCount = document.querySelector('.wishlist-count');
            if (wishlistCount) {
                wishlistCount.textContent = data.count || 0;
            }
        })
        .catch(error => console.error('Error updating wishlist count:', error));
    }

    // Add CSS for animations
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }
    `;
    document.head.appendChild(style);
    
    // Assign remaining helper functions to window
    window.changeQuantity = changeQuantity;
    window.addRecommendedItem = addRecommendedItem;
    window.closeRecommendationsModal = closeRecommendationsModal;
    
    console.log('‚úÖ All functions exposed globally');
</script>