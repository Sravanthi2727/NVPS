<!-- User Management Content -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="text-gold mb-2">
            <i class="fas fa-users me-2"></i>User Management
        </h1>
        <p style="color: var(--muted);">Manage user accounts and permissions</p>
    </div>
    <div class="btn-group">
        <button class="btn btn-primary" onclick="showAddUserModal()">
            <i class="fas fa-plus me-2"></i>Add User
        </button>
        <button class="btn btn-outline-primary" onclick="refreshCurrentPageData()">
            <i class="fas fa-sync-alt me-2"></i>Refresh
        </button>
        <button class="btn btn-outline-primary" onclick="exportCurrentPageData()">
            <i class="fas fa-download me-2"></i>Export
        </button>
    </div>
</div>

<!-- Filter and Search -->
<div class="admin-card mb-4" id="filtersCard">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5><i class="fas fa-filter me-2"></i>Filters & Search</h5>
        <button class="btn btn-outline-primary btn-sm" onclick="clearAllFilters()">
            <i class="fas fa-times me-1"></i>Clear All
        </button>
    </div>
    <div class="row g-3">
        <div class="col-md-3">
            <label class="form-label">Role</label>
            <select class="form-select" id="roleFilter">
                <option value="">All Roles</option>
                <option value="admin">Admin</option>
                <option value="customer">Customer</option>
                <option value="staff">Staff</option>
            </select>
        </div>
        <div class="col-md-3">
            <label class="form-label">Status</label>
            <select class="form-select" id="statusFilter">
                <option value="">All Status</option>
                <option value="active">Active</option>
                <option value="inactive">Inactive</option>
                <option value="suspended">Suspended</option>
            </select>
        </div>
        <div class="col-md-3">
            <label class="form-label">Join Date</label>
            <input type="date" class="form-control" id="dateFilter" placeholder="Filter by join date">
        </div>
        <div class="col-md-3">
            <label class="form-label">Search</label>
            <div class="input-group">
                <input type="text" class="form-control" id="searchFilter" placeholder="Search by name or email">
                <button class="btn btn-outline-primary" type="button" onclick="applyUserFilters()">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>
    </div>
    <div class="filter-stats mt-2"></div>
</div>

<!-- Users Table -->
<div class="admin-card">
    <h3>Users</h3>
    <div class="admin-table">
        <table class="table">
            <thead>
                <tr>
                    <th>User ID</th>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Role</th>
                    <th>Join Date</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <% if (typeof users !== 'undefined' && users.length > 0) { %>
                    <% users.forEach(user => { %>
                    <tr>
                        <td data-label="ID">#<%= user.id.toString().padStart(4, '0') %></td>
                        <td data-label="Name">
                            <div class="user-info">
                                <div class="user-avatar">
                                    <%= user.name.charAt(0).toUpperCase() %>
                                </div>
                                <strong><%= user.name %></strong>
                            </div>
                        </td>
                        <td data-label="Email"><%= user.email %></td>
                        <td data-label="Role">
                            <span class="badge bg-<%= user.role === 'admin' ? 'danger' : user.role === 'staff' ? 'warning' : 'primary' %>">
                                <%= user.role.charAt(0).toUpperCase() + user.role.slice(1) %>
                            </span>
                        </td>
                        <td data-label="Join Date"><%= new Date(user.joinDate).toLocaleDateString() %></td>
                        <td data-label="Status">
                            <span class="badge bg-<%= user.status === 'active' ? 'success' : user.status === 'inactive' ? 'secondary' : 'danger' %>">
                                <%= user.status.charAt(0).toUpperCase() + user.status.slice(1) %>
                            </span>
                        </td>
                        <td data-label="Actions">
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="viewUser(<%= user.id %>)">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="editUser(<%= user.id %>)">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    <% }); %>
                <% } else { %>
                    <tr>
                        <td colspan="7" class="text-center text-muted" style="padding: 2rem;">
                            <i class="fas fa-users text-muted" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i><br>
                            No users found.<br>
                            <small>Users will appear here when they register.</small>
                        </td>
                    </tr>
                <% } %>
            </tbody>
        </table>
    </div>
</div>

<!-- User Details Modal -->
<div class="modal fade" id="userModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="background: #1a1a1a; border: 1px solid #d6a45a;">
            <div class="modal-header" style="border-bottom: 1px solid #333;">
                <h5 class="modal-title" style="color: #d6a45a;">User Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="userModalBody">
                <!-- User details will be loaded here -->
            </div>
            <div class="modal-footer" style="border-top: 1px solid #333;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content" style="background: #1a1a1a; border: 1px solid #d6a45a;">
            <div class="modal-header" style="border-bottom: 1px solid #333;">
                <h5 class="modal-title" style="color: #d6a45a;">Edit User</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="editUserForm">
                <div class="modal-body">
                    <input type="hidden" id="editUserId">
                    
                    <div class="mb-3">
                        <label for="editUserName" class="form-label">Full Name</label>
                        <input type="text" class="form-control" id="editUserName" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editUserEmail" class="form-label">Email</label>
                        <input type="email" class="form-control" id="editUserEmail" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editUserPhone" class="form-label">Phone</label>
                        <input type="tel" class="form-control" id="editUserPhone">
                    </div>
                    
                    <div class="mb-3">
                        <label for="editUserRole" class="form-label">Role</label>
                        <select class="form-select" id="editUserRole" required>
                            <option value="customer">Customer</option>
                            <option value="staff">Staff</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editUserStatus" class="form-label">Status</label>
                        <select class="form-select" id="editUserStatus" required>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                            <option value="suspended">Suspended</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer" style="border-top: 1px solid #333;">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update User</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content" style="background: #1a1a1a; border: 1px solid #d6a45a;">
            <div class="modal-header" style="border-bottom: 1px solid #333;">
                <h5 class="modal-title" style="color: #d6a45a;">Add New User</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="userName" class="form-label">Full Name</label>
                        <input type="text" class="form-control" id="userName" required>
                    </div>
                    <div class="mb-3">
                        <label for="userEmail" class="form-label">Email</label>
                        <input type="email" class="form-control" id="userEmail" required>
                    </div>
                    <div class="mb-3">
                        <label for="userRole" class="form-label">Role</label>
                        <select class="form-select" id="userRole" required>
                            <option value="">Select Role</option>
                            <option value="customer">Customer</option>
                            <option value="staff">Staff</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="userPassword" class="form-label">Temporary Password</label>
                        <input type="password" class="form-control" id="userPassword" required>
                    </div>
                </div>
                <div class="modal-footer" style="border-top: 1px solid #333;">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add User</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.user-info {
    display: flex !important;
    align-items: center !important;
    gap: 0.75rem !important;
}

.user-avatar {
    width: 40px !important;
    height: 40px !important;
    border-radius: 50% !important;
    background: #d6a45a !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    color: #000 !important;
    font-weight: 600 !important;
    font-size: 1.1rem !important;
}
</style>

<script>
// Global variables
let allUsers = [];
let currentUser = null;

// Load users on page load
document.addEventListener('DOMContentLoaded', function() {
    loadUsers();
});

// Load users from API
async function loadUsers() {
    try {
        console.log('Loading users...');
        
        const response = await fetch('/api/admin/users', {
            method: 'GET',
            credentials: 'include'
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
            allUsers = result.users;
            renderUsersTable(allUsers);
            console.log('Users loaded successfully:', allUsers.length);
        } else {
            throw new Error(result.message || 'Failed to load users');
        }
    } catch (error) {
        console.error('Error loading users:', error);
        showToast('Failed to load users: ' + error.message, 'error');
    }
}

// Render users table
function renderUsersTable(users) {
    const tbody = document.querySelector('table tbody');
    
    if (!users || users.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-muted" style="padding: 2rem;">
                    <i class="fas fa-users text-muted" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i><br>
                    No users found.<br>
                    <small>Users will appear here when they register.</small>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = users.map(user => `
        <tr>
            <td data-label="ID">#${user.id.toString().slice(-4).padStart(4, '0')}</td>
            <td data-label="Name">
                <div class="user-info">
                    <div class="user-avatar">
                        ${user.name.charAt(0).toUpperCase()}
                    </div>
                    <strong>${user.name}</strong>
                </div>
            </td>
            <td data-label="Email">${user.email}</td>
            <td data-label="Role">
                <span class="badge bg-${user.role === 'admin' ? 'danger' : user.role === 'staff' ? 'warning' : 'primary'}">
                    ${user.role.charAt(0).toUpperCase() + user.role.slice(1)}
                </span>
            </td>
            <td data-label="Join Date">${new Date(user.joinDate).toLocaleDateString()}</td>
            <td data-label="Status">
                <span class="badge bg-${user.status === 'active' ? 'success' : user.status === 'inactive' ? 'secondary' : 'danger'}">
                    ${user.status.charAt(0).toUpperCase() + user.status.slice(1)}
                </span>
            </td>
            <td data-label="Actions">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="viewUser('${user.id}')">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="editUser('${user.id}')">
                        <i class="fas fa-edit"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

// View user details
async function viewUser(userId) {
    try {
        console.log('Viewing user:', userId);
        
        const response = await fetch(`/api/admin/users/${userId}`, {
            method: 'GET',
            credentials: 'include'
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
            const user = result.user;
            
            const userDetails = `
                <div class="user-details">
                    <div class="row">
                        <div class="col-md-4 text-center">
                            <div class="user-avatar" style="width: 80px; height: 80px; font-size: 2rem; margin: 0 auto 1rem;">
                                ${user.name.charAt(0).toUpperCase()}
                            </div>
                            <h5>${user.name}</h5>
                            <span class="badge bg-${user.role === 'admin' ? 'danger' : user.role === 'staff' ? 'warning' : 'primary'} mb-2">
                                ${user.role.charAt(0).toUpperCase() + user.role.slice(1)}
                            </span>
                            <br>
                            <span class="badge bg-${user.status === 'active' ? 'success' : user.status === 'inactive' ? 'secondary' : 'danger'}">
                                ${user.status.charAt(0).toUpperCase() + user.status.slice(1)}
                            </span>
                        </div>
                        <div class="col-md-8">
                            <h6 style="color: #d6a45a;">Contact Information</h6>
                            <p><strong>Email:</strong> ${user.email}<br>
                            <strong>Phone:</strong> ${user.phone || 'Not provided'}<br>
                            <strong>Join Date:</strong> ${new Date(user.joinDate).toLocaleDateString()}<br>
                            <strong>Account Type:</strong> ${user.isOAuthUser ? 'Google Account' : 'Regular Account'}</p>
                            
                            <h6 style="color: #d6a45a;">Activity Summary</h6>
                            <p><strong>Total Orders:</strong> ${user.totalOrders || 0}<br>
                            <strong>Total Spent:</strong> ₹${user.totalSpent || 0}<br>
                            <strong>Workshop Registrations:</strong> ${user.totalWorkshops || 0}<br>
                            <strong>Requests Submitted:</strong> ${user.totalRequests || 0}</p>
                            
                            ${user.recentOrders && user.recentOrders.length > 0 ? `
                                <h6 style="color: #d6a45a;">Recent Orders</h6>
                                <ul class="list-unstyled">
                                    ${user.recentOrders.slice(0, 3).map(order => `
                                        <li>• Order #${order._id.slice(-6).toUpperCase()} - ₹${order.totalAmount} - ${new Date(order.orderDate).toLocaleDateString()}</li>
                                    `).join('')}
                                </ul>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('userModalBody').innerHTML = userDetails;
            new bootstrap.Modal(document.getElementById('userModal')).show();
        } else {
            throw new Error(result.message || 'Failed to load user details');
        }
    } catch (error) {
        console.error('Error viewing user:', error);
        showToast('Failed to load user details: ' + error.message, 'error');
    }
}

// Edit user
async function editUser(userId) {
    try {
        console.log('Editing user:', userId);
        
        // Find user in current data
        const user = allUsers.find(u => u.id === userId);
        if (!user) {
            throw new Error('User not found');
        }
        
        // Populate edit form
        document.getElementById('editUserId').value = user.id;
        document.getElementById('editUserName').value = user.name;
        document.getElementById('editUserEmail').value = user.email;
        document.getElementById('editUserPhone').value = user.phone || '';
        document.getElementById('editUserRole').value = user.role;
        document.getElementById('editUserStatus').value = user.status;
        
        // Show edit modal
        new bootstrap.Modal(document.getElementById('editUserModal')).show();
        
    } catch (error) {
        console.error('Error editing user:', error);
        showToast('Failed to load user for editing: ' + error.message, 'error');
    }
}

// Handle edit user form submission
document.getElementById('editUserForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    try {
        const userId = document.getElementById('editUserId').value;
        const formData = {
            name: document.getElementById('editUserName').value,
            email: document.getElementById('editUserEmail').value,
            phone: document.getElementById('editUserPhone').value,
            role: document.getElementById('editUserRole').value,
            status: document.getElementById('editUserStatus').value
        };
        
        console.log('Updating user:', userId, formData);
        
        const response = await fetch(`/api/admin/users/${userId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify(formData)
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
            console.log('User updated successfully:', result.user);
            
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('editUserModal')).hide();
            
            // Show success message
            showToast('User updated successfully!', 'success');
            
            // Reload users
            await loadUsers();
        } else {
            throw new Error(result.message || 'Failed to update user');
        }
    } catch (error) {
        console.error('Error updating user:', error);
        showToast('Failed to update user: ' + error.message, 'error');
    }
});

// Handle add user form submission
document.querySelector('#addUserModal form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    try {
        const formData = {
            name: document.getElementById('userName').value,
            email: document.getElementById('userEmail').value,
            role: document.getElementById('userRole').value,
            password: document.getElementById('userPassword').value
        };
        
        console.log('Creating new user:', formData);
        
        const response = await fetch('/api/admin/users', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify(formData)
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
            console.log('User created successfully:', result.user);
            
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('addUserModal')).hide();
            
            // Reset form
            this.reset();
            
            // Show success message
            showToast('User created successfully!', 'success');
            
            // Reload users
            await loadUsers();
        } else {
            throw new Error(result.message || 'Failed to create user');
        }
    } catch (error) {
        console.error('Error creating user:', error);
        showToast('Failed to create user: ' + error.message, 'error');
    }
});

// Show add user modal
function showAddUserModal() {
    new bootstrap.Modal(document.getElementById('addUserModal')).show();
}

// Apply filters
function applyUserFilters() {
    const roleFilter = document.getElementById('roleFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;
    const dateFilter = document.getElementById('dateFilter').value;
    const searchFilter = document.getElementById('searchFilter').value.toLowerCase();
    
    let filteredUsers = allUsers;
    
    // Apply role filter
    if (roleFilter) {
        filteredUsers = filteredUsers.filter(user => user.role === roleFilter);
    }
    
    // Apply status filter
    if (statusFilter) {
        filteredUsers = filteredUsers.filter(user => user.status === statusFilter);
    }
    
    // Apply date filter
    if (dateFilter) {
        const filterDate = new Date(dateFilter);
        filteredUsers = filteredUsers.filter(user => {
            const userDate = new Date(user.joinDate);
            return userDate.toDateString() === filterDate.toDateString();
        });
    }
    
    // Apply search filter
    if (searchFilter) {
        filteredUsers = filteredUsers.filter(user => 
            user.name.toLowerCase().includes(searchFilter) ||
            user.email.toLowerCase().includes(searchFilter)
        );
    }
    
    renderUsersTable(filteredUsers);
    
    // Update filter stats
    const statsElement = document.querySelector('.filter-stats');
    if (statsElement) {
        statsElement.innerHTML = `<small class="text-muted">Showing ${filteredUsers.length} of ${allUsers.length} users</small>`;
    }
}

// Clear all filters
function clearAllFilters() {
    document.getElementById('roleFilter').value = '';
    document.getElementById('statusFilter').value = '';
    document.getElementById('dateFilter').value = '';
    document.getElementById('searchFilter').value = '';
    
    renderUsersTable(allUsers);
    
    const statsElement = document.querySelector('.filter-stats');
    if (statsElement) {
        statsElement.innerHTML = '';
    }
}

// Refresh data
function refreshCurrentPageData() {
    loadUsers();
}

// Export data (placeholder)
function exportCurrentPageData() {
    showToast('Export functionality coming soon!', 'info');
}

// Toast notification function
function showToast(message, type = 'info') {
    // Create toast element
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} alert-dismissible fade show`;
    toast.style.position = 'fixed';
    toast.style.top = '20px';
    toast.style.right = '20px';
    toast.style.zIndex = '9999';
    toast.style.minWidth = '300px';
    
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(toast);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
        }
    }, 5000);
}
</script>