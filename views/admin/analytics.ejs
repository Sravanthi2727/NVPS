<!-- Analytics Content -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="text-gold mb-2">
            <i class="fas fa-chart-line me-2"></i>Analytics Dashboard
        </h1>
        <p style="color: var(--muted);">Comprehensive insights and performance metrics</p>
    </div>
    <div>
        <button class="btn btn-outline-primary">
            <i class="fas fa-download me-2"></i>Export Data
        </button>
    </div>
</div>

<!-- Stats Grid -->
<div class="row g-4 mb-4">
    <div class="col-md-6 col-lg-3">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-users"></i>
            </div>
            <div class="stat-number" id="totalUsers"><%= typeof stats !== 'undefined' ? stats.totalCustomers : 7 %></div>
            <div class="stat-label">Total Users</div>
            <div class="stat-change positive">
                <i class="fas fa-arrow-up"></i>
                <span>700.0%</span>
            </div>
        </div>
    </div>
    
    <div class="col-md-6 col-lg-3">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-shopping-cart"></i>
            </div>
            <div class="stat-number" id="totalOrders"><%= typeof stats !== 'undefined' ? stats.totalOrders : 19 %></div>
            <div class="stat-label">Total Orders</div>
            <div class="stat-change positive">
                <i class="fas fa-arrow-up"></i>
                <span>1900.0%</span>
            </div>
        </div>
    </div>
    
    <div class="col-md-6 col-lg-3">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-rupee-sign"></i>
            </div>
            <div class="stat-number">₹<span id="totalRevenue"><%= typeof stats !== 'undefined' ? stats.totalRevenue.toLocaleString() : '19,550' %></span></div>
            <div class="stat-label">Total Revenue</div>
            <div class="stat-change positive">
                <i class="fas fa-arrow-up"></i>
                <span>195500.0%</span>
            </div>
        </div>
    </div>
    
    <div class="col-md-6 col-lg-3">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-calendar-alt"></i>
            </div>
            <div class="stat-number" id="workshopRegistrations"><%= typeof stats !== 'undefined' ? stats.workshopRegistrations : 4 %></div>
            <div class="stat-label">Workshop Registrations</div>
            <div class="stat-change positive">
                <i class="fas fa-arrow-up"></i>
                <span>400.0%</span>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row g-4 mb-4">
    <div class="col-lg-8">
        <div class="admin-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3>Daily Orders (Last 30 Days)</h3>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-sm btn-outline-primary active">Orders</button>
                    <button type="button" class="btn btn-sm btn-outline-primary">Revenue</button>
                    <button type="button" class="btn btn-sm btn-outline-primary">New Users</button>
                </div>
            </div>
            <div style="height: 300px; position: relative;">
                <canvas id="ordersChart"></canvas>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="admin-card">
            <h3 class="mb-3" id="pieChartTitle">Order Status Distribution</h3>
            <div style="height: 300px; position: relative;">
                <canvas id="orderStatusChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Additional Analytics -->
<div class="row g-4 mb-4">
    <div class="col-lg-6">
        <div class="admin-card">
            <h3 class="mb-3">Top Performing Items</h3>
            <div id="topItems">
                <div class="loading">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-6">
        <div class="admin-card">
            <h3 class="mb-3">Recent Activity</h3>
            <div id="recentActivity">
                <div class="loading">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Performance Metrics -->
<div class="row g-4">
    <div class="col-md-4">
        <div class="admin-card text-center">
            <div class="stat-icon mx-auto mb-3">
                <i class="fas fa-clock"></i>
            </div>
            <h5 class="text-gold">Peak Hours</h5>
            <p class="text-muted mb-0">12 PM - 2 PM</p>
            <small class="text-muted">Highest order volume</small>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="admin-card text-center">
            <div class="stat-icon mx-auto mb-3">
                <i class="fas fa-star"></i>
            </div>
            <h5 class="text-gold">Average Rating</h5>
            <p class="text-muted mb-0">4.8/5.0</p>
            <small class="text-muted">Customer satisfaction</small>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="admin-card text-center">
            <div class="stat-icon mx-auto mb-3">
                <i class="fas fa-redo"></i>
            </div>
            <h5 class="text-gold">Repeat Customers</h5>
            <p class="text-muted mb-0">68%</p>
            <small class="text-muted">Customer retention</small>
        </div>
    </div>
</div>

<style>
.popular-item, .activity-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 0;
    border-bottom: 1px solid var(--border);
    transition: all 0.3s ease;
}

.popular-item:last-child, .activity-item:last-child {
    border-bottom: none;
}

.popular-item:hover, .activity-item:hover {
    background: rgba(214, 164, 90, 0.05);
    margin: 0 -1rem;
    padding: 1rem;
    border-radius: 8px;
}

.item-info h6 {
    color: var(--gold);
    margin: 0;
    font-weight: 600;
}

.item-info small {
    color: var(--muted);
}

.item-stats {
    text-align: right;
}

.item-stats .orders {
    color: var(--text);
    font-weight: 600;
}

.item-stats .revenue {
    color: var(--muted);
    font-size: 0.9rem;
}

.activity-icon {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    background: rgba(214, 164, 90, 0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1rem;
    color: var(--gold);
    font-size: 1.1rem;
}

.activity-content h6 {
    color: var(--text);
    margin: 0;
    font-size: 0.95rem;
    font-weight: 500;
}

.activity-content small {
    color: var(--muted);
}

.btn-group .btn {
    border-color: var(--gold);
    color: var(--gold);
    transition: all 0.3s ease;
}

.btn-group .btn.active {
    background: var(--gold);
    color: #000;
    border-color: var(--gold);
}

.btn-group .btn:hover:not(.active) {
    background: rgba(214, 164, 90, 0.1);
    border-color: var(--soft-gold);
    color: var(--soft-gold);
}

#pieChartTitle {
    transition: all 0.3s ease;
    color: var(--gold);
}
</style>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadAnalytics();
    initCharts();
});

async function loadAnalytics() {
    try {
        const response = await fetch('/admin/api/analytics');
        const data = await response.json();
        
        if (data.success) {
            updateStats(data.stats);
            updateTopItems(data.popularItems);
            updateRecentActivity(data.recentActivity);
        } else {
            console.error('Analytics API error:', data.message);
            loadFallbackData();
        }
    } catch (error) {
        console.error('Error loading analytics:', error);
        loadFallbackData();
    }
}

function loadFallbackData() {
    // Use server-side data if available, otherwise use mock data
    <% if (typeof stats !== 'undefined') { %>
        updateStats({
            totalRevenue: <%= stats.totalRevenue %>,
            totalOrders: <%= stats.totalOrders %>,
            totalCustomers: <%= stats.totalCustomers %>,
            workshopRegistrations: <%= stats.workshopRegistrations %>
        });
    <% } else { %>
        updateStats({
            totalRevenue: 19550,
            totalOrders: 19,
            totalCustomers: 7,
            workshopRegistrations: 4
        });
    <% } %>
    
    <% if (typeof popularItems !== 'undefined' && popularItems.length > 0) { %>
        updateTopItems([
            <% popularItems.forEach((item, index) => { %>
                {
                    name: '<%= item.name %>',
                    orders: <%= item.orders %>,
                    revenue: <%= item.revenue %>
                }<%= index < popularItems.length - 1 ? ',' : '' %>
            <% }); %>
        ]);
    <% } else { %>
        updateTopItems([
            { name: 'Robusta Espresso', orders: 145, revenue: 21750 },
            { name: 'Art Gallery Burger', orders: 98, revenue: 19600 },
            { name: 'Creative Latte', orders: 87, revenue: 13050 },
            { name: 'Workshop Special Pizza', orders: 76, revenue: 15200 },
            { name: 'Artistic Smoothie', orders: 65, revenue: 9750 }
        ]);
    <% } %>
    
    <% if (typeof recentActivity !== 'undefined' && recentActivity.length > 0) { %>
        updateRecentActivity([
            <% recentActivity.forEach((activity, index) => { %>
                {
                    type: '<%= activity.type %>',
                    message: '<%= activity.message %>',
                    time: '<%= activity.time %>',
                    icon: '<%= activity.icon %>'
                }<%= index < recentActivity.length - 1 ? ',' : '' %>
            <% }); %>
        ]);
    <% } else { %>
        updateRecentActivity([
            { type: 'order', message: 'New order from John Doe', time: '2 minutes ago', icon: 'shopping-cart' },
            { type: 'user', message: 'New user registration', time: '15 minutes ago', icon: 'user-plus' },
            { type: 'workshop', message: 'Workshop booking confirmed', time: '1 hour ago', icon: 'calendar-check' },
            { type: 'art', message: 'Artwork purchased', time: '2 hours ago', icon: 'palette' },
            { type: 'franchise', message: 'New franchise inquiry', time: '3 hours ago', icon: 'handshake' }
        ]);
    <% } %>
}

function updateStats(stats) {
    document.getElementById('totalRevenue').textContent = stats.totalRevenue.toLocaleString();
    document.getElementById('totalOrders').textContent = stats.totalOrders.toLocaleString();
    document.getElementById('totalUsers').textContent = stats.totalCustomers.toLocaleString();
    document.getElementById('workshopRegistrations').textContent = stats.workshopRegistrations.toLocaleString();
}

function updateTopItems(items) {
    const container = document.getElementById('topItems');
    container.innerHTML = items.map((item, index) => `
        <div class="popular-item">
            <div class="d-flex align-items-center">
                <div class="me-3">
                    <span class="badge bg-primary">${index + 1}</span>
                </div>
                <div class="item-info">
                    <h6>${item.name}</h6>
                    <small>${item.orders} orders</small>
                </div>
            </div>
            <div class="item-stats">
                <div class="revenue">₹${item.revenue.toLocaleString()}</div>
            </div>
        </div>
    `).join('');
}

function updateRecentActivity(activities) {
    const container = document.getElementById('recentActivity');
    container.innerHTML = activities.map(activity => `
        <div class="activity-item">
            <div class="activity-icon">
                <i class="fas fa-${activity.icon}"></i>
            </div>
            <div class="activity-content flex-grow-1">
                <h6>${activity.message}</h6>
                <small>${activity.time}</small>
            </div>
        </div>
    `).join('');
}

function initCharts() {
    // Prepare all chart data
    <% if (typeof dailyOrders !== 'undefined' && dailyOrders.length > 0) { %>
        const dailyOrdersData = [
            <% dailyOrders.forEach((day, index) => { %>
                <%= day.count %><%= index < dailyOrders.length - 1 ? ',' : '' %>
            <% }); %>
        ];
        const dailyOrdersLabels = [
            <% dailyOrders.forEach((day, index) => { %>
                '<%= new Date(day.date).getDate() %>'<%= index < dailyOrders.length - 1 ? ',' : '' %>
            <% }); %>
        ];
    <% } else { %>
        const dailyOrdersData = [7, 6, 5, 4, 5, 4, 3, 2, 1, 2, 3, 4, 5, 6, 7, 6, 5, 4, 3, 2, 3, 4, 5, 6, 5, 4, 3, 2, 1, 1];
        const dailyOrdersLabels = Array.from({length: 30}, (_, i) => i + 1);
    <% } %>

    <% if (typeof dailyRevenue !== 'undefined' && dailyRevenue.length > 0) { %>
        const dailyRevenueData = [
            <% dailyRevenue.forEach((day, index) => { %>
                <%= day.revenue %><%= index < dailyRevenue.length - 1 ? ',' : '' %>
            <% }); %>
        ];
        const dailyRevenueLabels = [
            <% dailyRevenue.forEach((day, index) => { %>
                '<%= new Date(day.date).getDate() %>'<%= index < dailyRevenue.length - 1 ? ',' : '' %>
            <% }); %>
        ];
    <% } else { %>
        const dailyRevenueData = [1200, 1100, 950, 800, 1050, 900, 750, 600, 450, 700, 850, 1000, 1150, 1300, 1400, 1250, 1100, 950, 800, 650, 750, 900, 1050, 1200, 1100, 950, 800, 650, 500, 400];
        const dailyRevenueLabels = Array.from({length: 30}, (_, i) => i + 1);
    <% } %>

    <% if (typeof dailyUsers !== 'undefined' && dailyUsers.length > 0) { %>
        const dailyUsersData = [
            <% dailyUsers.forEach((day, index) => { %>
                <%= day.count %><%= index < dailyUsers.length - 1 ? ',' : '' %>
            <% }); %>
        ];
        const dailyUsersLabels = [
            <% dailyUsers.forEach((day, index) => { %>
                '<%= new Date(day.date).getDate() %>'<%= index < dailyUsers.length - 1 ? ',' : '' %>
            <% }); %>
        ];
    <% } else { %>
        const dailyUsersData = [2, 1, 3, 0, 2, 1, 0, 1, 0, 1, 2, 3, 2, 1, 3, 2, 1, 0, 1, 0, 1, 2, 1, 3, 2, 1, 0, 0, 1, 0];
        const dailyUsersLabels = Array.from({length: 30}, (_, i) => i + 1);
    <% } %>
    
    // Initialize main chart with orders data
    const ordersCtx = document.getElementById('ordersChart').getContext('2d');
    
    window.mainChart = new Chart(ordersCtx, {
        type: 'line',
        data: {
            labels: dailyOrdersLabels,
            datasets: [{
                label: 'Daily Orders',
                data: dailyOrdersData,
                borderColor: '#d6a45a',
                backgroundColor: 'rgba(214, 164, 90, 0.1)',
                tension: 0.4,
                fill: true,
                pointBackgroundColor: '#d6a45a',
                pointBorderColor: '#d6a45a',
                pointRadius: 4,
                pointHoverRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                x: {
                    ticks: {
                        color: '#ccc',
                        maxTicksLimit: 10
                    },
                    grid: {
                        color: '#333',
                        drawBorder: false
                    }
                },
                y: {
                    ticks: {
                        color: '#ccc',
                        beginAtZero: true
                    },
                    grid: {
                        color: '#333',
                        drawBorder: false
                    }
                }
            },
            elements: {
                point: {
                    hoverBackgroundColor: '#e3b873'
                }
            }
        }
    });

    // Store chart data for switching
    window.chartData = {
        orders: {
            labels: dailyOrdersLabels,
            data: dailyOrdersData,
            label: 'Daily Orders',
            color: '#d6a45a'
        },
        revenue: {
            labels: dailyRevenueLabels,
            data: dailyRevenueData,
            label: 'Daily Revenue (₹)',
            color: '#28a745'
        },
        users: {
            labels: dailyUsersLabels,
            data: dailyUsersData,
            label: 'New Users',
            color: '#17a2b8'
        }
    };

    // Initialize pie chart
    const statusCtx = document.getElementById('orderStatusChart').getContext('2d');
    
    // Prepare pie chart data for different sections
    window.pieChartData = {
        orders: {
            title: 'Order Status Distribution',
            <% if (typeof orderStatusStats !== 'undefined' && orderStatusStats.length > 0) { %>
                labels: [
                    <% orderStatusStats.forEach((stat, index) => { %>
                        '<%= stat._id.charAt(0).toUpperCase() + stat._id.slice(1) %>'<%= index < orderStatusStats.length - 1 ? ',' : '' %>
                    <% }); %>
                ],
                data: [
                    <% orderStatusStats.forEach((stat, index) => { %>
                        <%= stat.count %><%= index < orderStatusStats.length - 1 ? ',' : '' %>
                    <% }); %>
                ],
                colors: [
                    <% orderStatusStats.forEach((stat, index) => { %>
                        <% if (stat._id === 'completed') { %>
                            '#28a745'
                        <% } else if (stat._id === 'pending') { %>
                            '#d6a45a'
                        <% } else { %>
                            '#dc3545'
                        <% } %><%= index < orderStatusStats.length - 1 ? ',' : '' %>
                    <% }); %>
                ]
            <% } else { %>
                labels: ['Completed', 'Pending', 'Cancelled'],
                data: [75, 20, 5],
                colors: ['#28a745', '#d6a45a', '#dc3545']
            <% } %>
        },
        revenue: {
            title: 'Revenue Sources',
            labels: ['Menu Items', 'Artworks', 'Workshops', 'Other'],
            data: [65, 20, 12, 3],
            colors: ['#28a745', '#d6a45a', '#17a2b8', '#6c757d']
        },
        users: {
            title: 'User Registration Sources',
            labels: ['Website', 'Social Media', 'Referrals', 'Direct'],
            data: [45, 30, 15, 10],
            colors: ['#17a2b8', '#d6a45a', '#28a745', '#6c757d']
        }
    };

    // Initialize pie chart with orders data
    window.pieChart = new Chart(statusCtx, {
        type: 'doughnut',
        data: {
            labels: window.pieChartData.orders.labels,
            datasets: [{
                data: window.pieChartData.orders.data,
                backgroundColor: window.pieChartData.orders.colors,
                borderWidth: 0,
                cutout: '60%'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        color: '#fff',
                        padding: 20,
                        usePointStyle: true,
                        pointStyle: 'circle'
                    }
                }
            }
        }
    });

    // Add event listeners for chart switching
    const chartButtons = document.querySelectorAll('.btn-group .btn');
    chartButtons.forEach((btn, index) => {
        btn.addEventListener('click', function() {
            // Remove active class from all buttons
            chartButtons.forEach(b => b.classList.remove('active'));
            // Add active class to clicked button
            this.classList.add('active');
            
            // Switch chart data
            const chartTypes = ['orders', 'revenue', 'users'];
            const chartType = chartTypes[index];
            const chartInfo = window.chartData[chartType];
            const pieInfo = window.pieChartData[chartType];
            
            // Update line chart
            window.mainChart.data.labels = chartInfo.labels;
            window.mainChart.data.datasets[0].data = chartInfo.data;
            window.mainChart.data.datasets[0].label = chartInfo.label;
            window.mainChart.data.datasets[0].borderColor = chartInfo.color;
            window.mainChart.data.datasets[0].backgroundColor = chartInfo.color + '20';
            window.mainChart.data.datasets[0].pointBackgroundColor = chartInfo.color;
            window.mainChart.data.datasets[0].pointBorderColor = chartInfo.color;
            
            window.mainChart.update();

            // Update pie chart
            document.getElementById('pieChartTitle').textContent = pieInfo.title;
            window.pieChart.data.labels = pieInfo.labels;
            window.pieChart.data.datasets[0].data = pieInfo.data;
            window.pieChart.data.datasets[0].backgroundColor = pieInfo.colors;
            
            window.pieChart.update();
        });
    });
}
</script>