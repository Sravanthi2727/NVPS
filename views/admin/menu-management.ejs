<!-- Add New Menu Item Form -->
<div class="admin-card">
    <h3>
        <i class="fas fa-plus-circle me-2"></i>Add New Menu Item
    </h3>
    
    <form id="menuForm" enctype="multipart/form-data">
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label class="form-label">Item Name *</label>
                    <input type="text" class="form-control" name="name" required>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="mb-3">
                    <label class="form-label">Category *</label>
                    <select class="form-select" name="category" required>
                        <option value="">Select Category</option>
                        <option value="cold">Cold Coffee</option>
                        <option value="hot">Hot Coffee</option>
                        <option value="manual-brew">Manual Brew</option>
                        <option value="shakes-tea">Shakes & Tea</option>
                        <option value="food">Food</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-4">
                <div class="mb-3">
                    <label class="form-label">Price (₹) *</label>
                    <input type="number" class="form-control" name="price" step="0.01" required>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="mb-3">
                    <label class="form-label">Display Order</label>
                    <input type="number" class="form-control" name="displayOrder" value="0" placeholder="0 = first">
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="mb-3">
                    <label class="form-label">Available</label>
                    <select class="form-select" name="isAvailable">
                        <option value="true">Available</option>
                        <option value="false">Hidden</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="mb-3">
            <label class="form-label">Description *</label>
            <textarea class="form-control" name="description" rows="3" placeholder="Describe the menu item..." required></textarea>
        </div>

        <div class="mb-3">
            <label class="form-label">Item Image URL *</label>
            <input type="text" class="form-control" name="image" placeholder="Enter image URL" required>
            <small class="text-muted">Provide a URL to the menu item image</small>
        </div>

        <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-save me-2"></i>Add Menu Item
            </button>
            <button type="button" class="btn btn-outline-primary" onclick="resetMenuForm()">
                <i class="fas fa-redo me-2"></i>Reset
            </button>
        </div>
    </form>
</div>

<!-- Existing Menu Items Table -->
<div class="admin-card">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>Existing Menu Items</h3>
        <span class="text-muted">Total: <span id="menuItemCount"><%= typeof menuItems !== 'undefined' ? menuItems.length : 0 %></span> items</span>
    </div>
    
    <!-- Filters -->
    <div class="row mb-3">
        <div class="col-md-3">
            <input type="text" class="form-control" id="searchMenuFilter" placeholder="Search menu items..." onkeyup="applyMenuFilters()">
        </div>
        <div class="col-md-2">
            <select class="form-select" id="categoryMenuFilter" onchange="applyMenuFilters()">
                <option value="">All Categories</option>
                <option value="cold">Cold Coffee</option>
                <option value="hot">Hot Coffee</option>
                <option value="manual-brew">Manual Brew</option>
                <option value="shakes-tea">Shakes & Tea</option>
                <option value="food">Food</option>
            </select>
        </div>
        <div class="col-md-2">
            <select class="form-select" id="availabilityMenuFilter" onchange="applyMenuFilters()">
                <option value="">All Status</option>
                <option value="true">Available</option>
                <option value="false">Hidden</option>
            </select>
        </div>
        <div class="col-md-2">
            <select class="form-select" id="priceMenuFilter" onchange="applyMenuFilters()">
                <option value="">All Prices</option>
                <option value="0-100">₹0 - ₹100</option>
                <option value="100-300">₹100 - ₹300</option>
                <option value="300-500">₹300 - ₹500</option>
                <option value="500+">₹500+</option>
            </select>
        </div>
        <div class="col-md-3">
            <button class="btn btn-outline-secondary" onclick="clearMenuFilters()">
                <i class="fas fa-times me-1"></i>Clear Filters
            </button>
        </div>
    </div>
    
    <div class="admin-table">
        <table class="table" id="menuItemsTable">
            <thead>
                <tr>
                    <th>Image</th>
                    <th>Name</th>
                    <th>Category</th>
                    <th>Price</th>
                    <th>Availability</th>
                    <th>Display Order</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="menuItemsTableBody">
                <% if (typeof menuItems !== 'undefined' && menuItems.length > 0) { %>
                    <% menuItems.forEach(item => { %>
                        <tr class="menu-item-row" 
                            data-name="<%= item.name.toLowerCase() %>"
                            data-category="<%= item.category %>"
                            data-availability="<%= item.isAvailable %>"
                            data-price="<%= item.price %>">
                            <td>
                                <% if (item.image) { %>
                                    <img src="<%= item.image.startsWith('/') ? item.image : '/assets/menu_images/' + item.image %>" 
                                         alt="<%= item.name %>" 
                                         class="menu-item-image" 
                                         style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px; border: 1px solid rgba(214, 164, 90, 0.3);"
                                         onerror="this.src='/assets/placeholder.jpg';">
                                <% } else { %>
                                    <div style="width: 60px; height: 60px; background: #333; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-utensils text-muted"></i>
                                    </div>
                                <% } %>
                            </td>
                            <td><strong><%= item.name %></strong></td>
                            <td><span class="badge bg-info"><%= item.category %></span></td>
                            <td>₹<%= item.price.toLocaleString() %></td>
                            <td>
                                <span class="badge <%= item.isAvailable ? 'bg-success' : 'bg-secondary' %>">
                                    <%= item.isAvailable ? 'Available' : 'Hidden' %>
                                </span>
                            </td>
                            <td><%= item.displayOrder || 0 %></td>
                            <td>
                                <div class="btn-group">
                                    <button class="btn btn-outline-primary btn-sm" onclick="editMenuItem('<%= item._id %>')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm" onclick="deleteMenuItem('<%= item._id %>')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    <% }); %>
                <% } else { %>
                    <tr id="noMenuItemsRow">
                        <td colspan="7" class="text-center text-muted" style="padding: 2rem;">
                            <i class="fas fa-utensils text-muted" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i><br>
                            No menu items found.<br>
                            <small>Add menu items using the form above.</small>
                        </td>
                    </tr>
                <% } %>
            </tbody>
        </table>
    </div>
</div>

<!-- Add/Edit Menu Item Modal -->
<div class="modal fade" id="menuModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Add Menu Item</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="menuEditForm" enctype="multipart/form-data">
                    <input type="hidden" id="menuItemId">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Item Name *</label>
                                <input type="text" class="form-control" id="editName" required>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Category *</label>
                                <select class="form-select" id="editCategory" required>
                                    <option value="">Select Category</option>
                                    <option value="cold">Cold Coffee</option>
                                    <option value="hot">Hot Coffee</option>
                                    <option value="manual-brew">Manual Brew</option>
                                    <option value="shakes-tea">Shakes & Tea</option>
                                    <option value="food">Food</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Price (₹) *</label>
                                <input type="number" class="form-control" id="editPrice" step="0.01" required>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Display Order</label>
                                <input type="number" class="form-control" id="editDisplayOrder" value="0" placeholder="0 = first">
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Available</label>
                                <select class="form-select" id="editIsAvailable">
                                    <option value="true">Available</option>
                                    <option value="false">Hidden</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Description *</label>
                        <textarea class="form-control" id="editDescription" rows="3" placeholder="Describe the menu item..." required></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Item Image URL *</label>
                        <input type="text" class="form-control" id="editImage" placeholder="Enter image URL" required>
                        <div id="currentImagePreview" class="mt-2"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveMenuItem()">
                    <i class="fas fa-save me-2"></i>Save Item
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Load menu items on page load
document.addEventListener('DOMContentLoaded', function() {
    loadMenuItems();
});

async function loadMenuItems() {
    try {
        const response = await fetch('/admin/api/menu-items');
        const data = await response.json();
        
        if (data.success) {
            renderMenuItems(data.items);
        }
    } catch (error) {
        console.error('Error loading menu items:', error);
    }
}

function renderMenuItems(items) {
    const tbody = document.querySelector('.admin-table tbody');
    
    if (!items || items.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-muted" style="padding: 2rem;">
                    <i class="fas fa-utensils text-muted" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i><br>
                    No menu items found.<br>
                    <small>Add menu items using form above.</small>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = items.map(item => `
        <tr>
            <td>
                ${item.image ? 
                    `<img src="${item.image.startsWith('/') ? item.image : '/assets/menu_images/' + item.image}" alt="${item.name}" class="menu-item-image" style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px; border: 1px solid rgba(214, 164, 90, 0.3);" onerror="this.src='/assets/placeholder.jpg';">` :
                    `<div style="width: 60px; height: 60px; background: #333; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-utensils text-muted"></i>
                    </div>`
                }
            </td>
            <td><strong>${item.name}</strong></td>
            <td><span class="badge bg-info">${item.category}</span></td>
            <td>₹${item.price.toLocaleString()}</td>
            <td>
                <span class="badge ${item.isAvailable ? 'bg-success' : 'bg-secondary'}">
                    ${item.isAvailable ? 'Available' : 'Hidden'}
                </span>
            </td>
            <td>${item.displayOrder || 0}</td>
            <td>
                <div class="btn-group">
                    <button class="btn btn-outline-primary btn-sm" onclick="editMenuItem('${item._id}')">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-outline-danger btn-sm" onclick="deleteMenuItem('${item._id}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
    
    // Update total count
    const totalSpan = document.querySelector('.text-muted');
    if (totalSpan) {
        totalSpan.textContent = `Total: ${items.length} items`;
    }
}

// Form submission
document.getElementById('menuForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const itemData = Object.fromEntries(formData.entries());
    
    try {
        const response = await fetch('/admin/api/menu-items', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(itemData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('Menu item added successfully!');
            this.reset();
            loadMenuItems(); // Reload items instead of page reload
        } else {
            alert('Error adding menu item: ' + result.message);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error adding menu item');
    }
});

function resetMenuForm() {
    document.getElementById('menuForm').reset();
}

async function editMenuItem(id) {
    try {
        // Fetch menu item data
        const response = await fetch(`/admin/api/menu-items/${id}`);
        const result = await response.json();
        
        if (result.success) {
            const item = result.item;
            
            // Populate modal with item data
            document.getElementById('modalTitle').textContent = 'Edit Menu Item';
            document.getElementById('menuItemId').value = item._id;
            document.getElementById('editName').value = item.name;
            document.getElementById('editCategory').value = item.category;
            document.getElementById('editPrice').value = item.price;
            document.getElementById('editDisplayOrder').value = item.displayOrder || 0;
            document.getElementById('editIsAvailable').value = item.isAvailable ? 'true' : 'false';
            document.getElementById('editDescription').value = item.description;
            document.getElementById('editImage').value = item.image;
            
            // Show current image preview
            const imagePreview = document.getElementById('currentImagePreview');
            if (item.image) {
                imagePreview.innerHTML = `
                    <div class="d-flex align-items-center gap-2">
                        <img src="${item.image.startsWith('/') ? item.image : '/assets/menu_images/' + item.image}" alt="Current image" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px; border: 1px solid #d6a45a;" onerror="this.src='/assets/placeholder.jpg';">
                        <small class="text-muted">Current image</small>
                    </div>
                `;
            } else {
                imagePreview.innerHTML = '<small class="text-muted">No current image</small>';
            }
            
            // Show modal
            new bootstrap.Modal(document.getElementById('menuModal')).show();
        } else {
            alert('Error fetching menu item: ' + result.message);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error fetching menu item');
    }
}

async function saveMenuItem() {
    const itemId = document.getElementById('menuItemId').value;
    const isEdit = itemId !== '';
    
    const itemData = {
        name: document.getElementById('editName').value,
        category: document.getElementById('editCategory').value,
        price: parseFloat(document.getElementById('editPrice').value),
        displayOrder: parseInt(document.getElementById('editDisplayOrder').value),
        isAvailable: document.getElementById('editIsAvailable').value === 'true',
        description: document.getElementById('editDescription').value,
        image: document.getElementById('editImage').value
    };
    
    try {
        const url = isEdit ? `/admin/api/menu-items/${itemId}` : '/admin/api/menu-items';
        const method = isEdit ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(itemData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            bootstrap.Modal.getInstance(document.getElementById('menuModal')).hide();
            alert(`Menu item ${isEdit ? 'updated' : 'added'} successfully!`);
            loadMenuItems(); // Reload items instead of page reload
            document.getElementById('menuForm').reset(); // Reset add form
        } else {
            alert(`Error ${isEdit ? 'updating' : 'adding'} menu item: ` + result.message);
        }
    } catch (error) {
        console.error('Error:', error);
        alert(`Error ${isEdit ? 'updating' : 'adding'} menu item`);
    }
}

async function deleteMenuItem(id) {
    if (confirm('Are you sure you want to delete this menu item?')) {
        try {
            const response = await fetch(`/admin/api/menu-items/${id}`, {
                method: 'DELETE'
            });
            
            const result = await response.json();
            
            if (result.success) {
                alert('Menu item deleted successfully!');
                loadMenuItems(); // Reload items instead of page reload
            } else {
                alert('Error deleting menu item: ' + result.message);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error deleting menu item');
        }
    }
}

// Menu filter functionality
function applyMenuFilters() {
    const searchTerm = document.getElementById('searchMenuFilter').value.toLowerCase();
    const categoryFilter = document.getElementById('categoryMenuFilter').value;
    const availabilityFilter = document.getElementById('availabilityMenuFilter').value;
    const priceFilter = document.getElementById('priceMenuFilter').value;
    
    const rows = document.querySelectorAll('.menu-item-row');
    let visibleCount = 0;
    
    rows.forEach(row => {
        const name = row.dataset.name;
        const category = row.dataset.category;
        const availability = row.dataset.availability;
        const price = parseFloat(row.dataset.price);
        
        let showRow = true;
        
        // Search filter
        if (searchTerm && !name.includes(searchTerm)) {
            showRow = false;
        }
        
        // Category filter
        if (categoryFilter && category !== categoryFilter) {
            showRow = false;
        }
        
        // Availability filter
        if (availabilityFilter && availability.toString() !== availabilityFilter) {
            showRow = false;
        }
        
        // Price filter
        if (priceFilter) {
            if (priceFilter === '0-100' && (price < 0 || price > 100)) {
                showRow = false;
            } else if (priceFilter === '100-300' && (price < 100 || price > 300)) {
                showRow = false;
            } else if (priceFilter === '300-500' && (price < 300 || price > 500)) {
                showRow = false;
            } else if (priceFilter === '500+' && price < 500) {
                showRow = false;
            }
        }
        
        row.style.display = showRow ? '' : 'none';
        if (showRow) visibleCount++;
    });
    
    // Update count
    document.getElementById('menuItemCount').textContent = visibleCount;
    
    // Show/hide no results message
    const noResultsRow = document.getElementById('noMenuItemsRow');
    if (noResultsRow) {
        noResultsRow.style.display = visibleCount === 0 ? '' : 'none';
    }
}

function clearMenuFilters() {
    document.getElementById('searchMenuFilter').value = '';
    document.getElementById('categoryMenuFilter').value = '';
    document.getElementById('availabilityMenuFilter').value = '';
    document.getElementById('priceMenuFilter').value = '';
    applyMenuFilters();
}
</script>
